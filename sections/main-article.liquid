{%- liquid
  assign article_show_sharing = section.settings.article_show_sharing
  assign article_show_nav = section.settings.article_show_nav

  assign article_card_shadow = settings.article_card_shadow
  assign article_card_shadow_class = 'has-shadow--' | append: article_card_shadow
-%}
{{ 'article.css' | asset_url | stylesheet_tag }}
{%- render 'article-navigation', article_show_nav: article_show_nav, article_show_sharing: article_show_sharing -%}
<div class="blog-post-detail--wrapper section-spacing-bottom">
  <div class="row">

    <!-- Table of Contents Column -->
    <div class="small-3 columns" id="table-of-contents-column">
      <div class="table-of-contents" id="table-of-contents">
        <h3>Contents</h3>
        <ul>
          {% assign headings = article.content | split: '<h2>' %}
          {% for heading in headings %}
            {% if forloop.index > 1 %}
              {% assign heading_title = heading | split: '</h2>' | first %}
              <li><a href="#heading-{{ forloop.index }}">{{ heading_title | strip_html | truncate: 50 }}</a></li>

              <!-- Process H3 inside H2 -->
              {% assign subheadings = heading | split: '<h3>' %}
              {% for subheading in subheadings %}
                {% if forloop.index > 1 %}
                  {% assign subheading_title = subheading | split: '</h3>' | first %}
                  <li class="toc-subheading"><a href="#subheading-{{ forloop.parent.index }}-{{ forloop.index }}">{{ subheading_title | strip_html | truncate: 50 }}</a></li>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Blog Content Column -->
    <div class="small-9 columns">
      <article class="blog-post-detail" id="main-article">
        {% for block in section.blocks %}
          {% if block.type == '@app' %}
            <div class="page-content-width">
              {% render block %}
            </div>
          {% endif %}
          {% if block.type == 'title' %}
          {%- liquid
            assign has_image = false
            if article.image
              assign has_image = true
            endif

            assign article_card_border = settings.article_card_border
          -%}
          <div class="post-title-wrapper post-title-wrapper--has-img-{{- has_image }} post-title-wrapper--border-{{ article_card_border }} {{ article_card_shadow_class }}" id="post-title-wrapper" {{ block.shopify_attributes }}>
            <div class="post-title">
              {% if section.settings.article_show_date or section.settings.article_show_author %}
              <div class="post-meta-wrapper">
                {%- if section.settings.article_show_date -%}
                <aside class="post-meta">
                  {{- article.published_at | time_tag: '%b %d, %Y' -}}
                </aside>
                {%- endif -%}
                {%- if section.settings.article_show_author -%}
                <aside class="post-author">{{- article.author -}}</aside>
                {% endif %}
              </div>
              {% endif %}
              <h1 class="entry-title h2">{{ article.title }}</h1>
              {%- liquid
                if article_show_sharing
                  render 'social-share', share_label: true, share_title: article.title, share_permalink: article.url, share_image: article.featured_image
                endif
              -%}
            </div>
            {%- if article.image -%}
            <div class="featured-image">
              {%- render 'responsive-image', image: article.image, sizes: '345x300,640x550,1280x1100' -%}
            </div>
            {%- endif -%}
          </div>
          {% endif %}
          {% if block.type == 'content' %}

          <!-- Updated Content Processing -->
          <div class="post-content page-content-width rte" {{ block.shopify_attributes }}>
            {% assign updated_content = article.content %}

            <!-- Add IDs to H2 tags -->
            {% assign updated_content = updated_content | replace: '<h2>', '<h2 id="heading-' %}
            {% assign updated_content = updated_content | replace: '</h2>', '</h2>' %}

            <!-- Add IDs to H3 tags -->
            {% assign updated_content = updated_content | replace: '<h3>', '<h3 id="subheading-' %}
            {% assign updated_content = updated_content | replace: '</h3>', '</h3>' %}

            <!-- Output the processed content -->
            {{ updated_content }}
          </div>
          <!-- End of Updated Content Processing -->

          {% endif %}
          {% if block.type == 'tags' %}
            {%- if article.tags.size > 0 -%}
            <footer class="article-tags page-content-width" {{ block.shopify_attributes }}>
              {% for tag in article.tags %}
                <a href="{{ blog.url | escape }}/tagged/{{ tag | handle }}" class="tag-link">{{ tag }}</a>
              {% endfor %}
            </footer>
            {%- endif -%}
          {% endif %}
          {% if block.type == 'post_navigation' %}
            {%- liquid
              assign current_found = false
              assign done = false

              for a in blog.articles
                if current_found and done == false
                  assign next_article = a
                  assign done = true
                endif
                unless done
                  if a.id == article.id
                    assign current_found = true
                  endif
                endunless
              endfor
            -%}
            {%- if next_article -%}
            <div class="page-content-width">
              <div class="blog-post-detail--continue {{ article_card_shadow_class }} blog-post-detail--continue--border-{{ article_card_border }}">
                <div class="blog-post-detail--continue-content">
                  <span class="blog-post-detail--continue-title">{{ 'blogs.article.continue_reading' | t }}</span>
                  <h5><a href="{{ next_article.url }}" title="{{ next_article.title | escape }}">{{ next_article.title }}</a></h5>
                  {%- assign read_more = 'blogs.article.read_more' | t -%}
                  {%- render 'text-button', url: next_article.url, title: read_more -%}
                </div>
                {%- if next_article.image -%}
                <div class="blog-post-detail--continue-image">
                  <a href="{{ next_article.url }}" title="{{ next_article.title | escape }}">
                    {%- render 'responsive-image', image: next_article.image, sizes: '380x360' -%}
                  </a>
                </div>
                {%- endif -%}
              </div>
            </div>
            {%- endif -%}
          {% endif %}
        {% endfor %}
        <div class="blog-post-detail--end"></div>
      </article>
    </div>
  </div>
</div>
<script type="application/ld+json">
  {{ article | structured_data }}
</script>
